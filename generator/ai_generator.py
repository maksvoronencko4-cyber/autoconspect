"""
AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤ ‚Äî Wikipedia + Gemini
"""

import google.generativeai as genai
from datetime import datetime
from .wikipedia_source import WikipediaSource


class AIGenerator:
    
    def __init__(self, api_key: str = None):
        self.model = None
        self.is_ready = False
        self.model_name = None
        self.error_message = None
        self.wiki = WikipediaSource(language='ru')
        
        print(f"üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞...")
        print(f"üîë API –∫–ª—é—á –ø–æ–ª—É—á–µ–Ω: {'–î–∞' if api_key else '–ù–µ—Ç'}")
        
        if api_key and len(api_key) > 10:
            self._init_model(api_key)
        else:
            self.error_message = "API –∫–ª—é—á –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π"
            print(f"‚ùå {self.error_message}")
    
    def _init_model(self, api_key: str):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ Gemini"""
        try:
            print("üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini API...")
            genai.configure(api_key=api_key)
            
            models_to_try = [
                'gemini-1.5-flash',
                'gemini-1.5-pro',
                'gemini-pro',
                'gemini-1.0-pro',
            ]
            
            for model_name in models_to_try:
                try:
                    print(f"üîÑ –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å: {model_name}")
                    model = genai.GenerativeModel(model_name)
                    response = model.generate_content("–ü—Ä–∏–≤–µ—Ç")
                    if response.text:
                        self.model = model
                        self.model_name = model_name
                        self.is_ready = True
                        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –º–æ–¥–µ–ª—å: {model_name}")
                        return
                except Exception as e:
                    print(f"‚ùå –ú–æ–¥–µ–ª—å {model_name} –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: {e}")
                    continue
            
            self.error_message = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–∏ –æ–¥–Ω—É –º–æ–¥–µ–ª—å"
            self.is_ready = False
            print(f"‚ùå {self.error_message}")
            
        except Exception as e:
            self.error_message = f"–û—à–∏–±–∫–∞ API: {str(e)}"
            self.is_ready = False
            print(f"‚ùå {self.error_message}")
    
    def generate(self, mode: str, topic: str, volume: str, style: str, 
                 author_info: dict = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏"""
        
        if not self.is_ready:
            error_details = self.error_message or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
            return f"""‚ùå API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.

–ü—Ä–∏—á–∏–Ω–∞: {error_details}

–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ Render ‚Üí –≤–∞—à —Å–µ—Ä–≤–∏—Å ‚Üí Environment
2. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é GEMINI_API_KEY
3. –ó–Ω–∞—á–µ–Ω–∏–µ: –≤–∞—à –∫–ª—é—á —Å aistudio.google.com
4. –ù–∞–∂–º–∏—Ç–µ Save Changes
5. –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"""
        
        # 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏
        print(f"üîç –ü–æ–∏—Å–∫ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏: {topic}")
        wiki_data = self.wiki.get_data_for_topic(topic)
        print(f"üìñ –í–∏–∫–∏–ø–µ–¥–∏—è: {'–ù–∞–π–¥–µ–Ω–æ' if wiki_data.get('success') else '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'}")
        
        # 2. –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç
        prompt = self._build_prompt(mode, topic, volume, style, wiki_data)
        
        try:
            # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Gemini
            print("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞...")
            response = self.model.generate_content(prompt)
            result = response.text
            print("‚úÖ –¢–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
            
            # 4. –¢–∏—Ç—É–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
            if author_info and author_info.get('include_title') and mode in ['referat', 'doklad', 'essay']:
                title_page = self._generate_title_page(topic, author_info, mode)
                result = title_page + "\n\n" + result
            
            return result
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}"
    
    def _build_prompt(self, mode: str, topic: str, volume: str, style: str, wiki_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏"""
        
        volume_text = {
            "short": "1-2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã",
            "medium": "3-5 —Å—Ç—Ä–∞–Ω–∏—Ü",
            "long": "6-10 —Å—Ç—Ä–∞–Ω–∏—Ü",
            "very_long": "10-15 —Å—Ç—Ä–∞–Ω–∏—Ü"
        }.get(volume, "3-5 —Å—Ç—Ä–∞–Ω–∏—Ü")
        
        style_text = {
            "scientific": "–Ω–∞—É—á–Ω—ã–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å",
            "simple": "–ø—Ä–æ—Å—Ç–æ–π –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫",
            "school": "—è–∑—ã–∫ –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–∞",
            "university": "—è–∑—ã–∫ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞"
        }.get(style, "–Ω–∞—É—á–Ω—ã–π —Å—Ç–∏–ª—å")
        
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –í–∏–∫–∏–ø–µ–¥–∏–∏
        if wiki_data.get('success'):
            wiki_context = f"""
–î–ê–ù–ù–´–ï –ü–û –¢–ï–ú–ï "{topic}":
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{wiki_data['content']}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ò–ù–°–¢–†–£–ö–¶–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤—ã—à–µ
- –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–µ –∫–æ–ø–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ª–æ–≥–∏—á–Ω–æ
- –ù–ï —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ —Ä–∞–±–æ—Ç—ã
"""
        else:
            wiki_context = f"""
–ù–∞–ø–∏—à–∏ —Ä–∞–±–æ—Ç—É –Ω–∞ —Ç–µ–º—É "{topic}", –∏—Å–ø–æ–ª—å–∑—É—è –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è.
"""
        
        # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
        prompts = {
            "referat": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –ù–∞–ø–∏—à–∏ —Ä–µ—Ñ–µ—Ä–∞—Ç –Ω–∞ —Ç–µ–º—É "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–¥–µ–ª "–ò—Å—Ç–æ—á–Ω–∏–∫–∏" –∏–ª–∏ "–°–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã" –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê –†–ï–§–ï–†–ê–¢–ê:

# –†–ï–§–ï–†–ê–¢
## –¢–µ–º–∞: {topic}

## –í–í–ï–î–ï–ù–ò–ï
(–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, —Ü–µ–ª—å, –∑–∞–¥–∞—á–∏ ‚Äî 1-2 –∞–±–∑–∞—Ü–∞)

## –ì–õ–ê–í–ê 1. [–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ —Ç–µ–º–µ]
### 1.1 [–ü–æ–¥—Ä–∞–∑–¥–µ–ª]
(—Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Ñ–∞–∫—Ç–∞–º–∏)

### 1.2 [–ü–æ–¥—Ä–∞–∑–¥–µ–ª]
(–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

## –ì–õ–ê–í–ê 2. [–ù–∞–∑–≤–∞–Ω–∏–µ]
### 2.1 [–ü–æ–¥—Ä–∞–∑–¥–µ–ª]
(—Ç–µ–∫—Å—Ç)

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
(–≤—ã–≤–æ–¥—ã –ø–æ —Ä–∞–±–æ—Ç–µ)

–ü–∏—à–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ!""",

            "conspect": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –ù–∞–ø–∏—à–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ —Ç–µ–º—É "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê:

# üìù –ö–û–ù–°–ü–ï–ö–¢: {topic}

## üîë –ö–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è
**–¢–µ—Ä–º–∏–Ω** ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
(3-5 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤)

## üìö –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è

### 1. [–†–∞–∑–¥–µ–ª]
‚Ä¢ –¢–µ–∑–∏—Å
‚Ä¢ –¢–µ–∑–∏—Å
‚Ä¢ –¢–µ–∑–∏—Å

### 2. [–†–∞–∑–¥–µ–ª]
‚Ä¢ –¢–µ–∑–∏—Å
‚Ä¢ –¢–µ–∑–∏—Å

### 3. [–†–∞–∑–¥–µ–ª]
‚Ä¢ –¢–µ–∑–∏—Å

## ‚úÖ –í—ã–≤–æ–¥—ã
1. –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥
2. –í—Ç–æ—Ä–æ–π –≤—ã–≤–æ–¥
3. –¢—Ä–µ—Ç–∏–π –≤—ã–≤–æ–¥

## üí° –ó–∞–ø–æ–º–Ω–∏—Ç—å
‚Ä¢ –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ""",

            "doklad": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –¥–æ–∫–ª–∞–¥–∞ –Ω–∞ —Ç–µ–º—É "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –§–æ—Ä–º–∞—Ç: —Ç–µ–∫—Å—Ç –¥–ª—è —É—Å—Ç–Ω–æ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê:

# üìä –î–û–ö–õ–ê–î
## –¢–µ–º–∞: {topic}

## –í–°–¢–£–ü–õ–ï–ù–ò–ï
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –°–µ–≥–æ–¥–Ω—è —è —Ä–∞—Å—Å–∫–∞–∂—É –æ —Ç–µ–º–µ "{topic}".
(–ø–æ—á–µ–º—É —Ç–µ–º–∞ –≤–∞–∂–Ω–∞, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

## –û–°–ù–û–í–ù–ê–Ø –ß–ê–°–¢–¨

### [–ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç]
(—Ä–∞—Å—Å–∫–∞–∑ —Å —Ñ–∞–∫—Ç–∞–º–∏, 2-3 –∞–±–∑–∞—Ü–∞)

### [–í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç]
(–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

### [–¢—Ä–µ—Ç–∏–π –ø—É–Ω–∫—Ç]
(–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã
‚Ä¢ –§–∞–∫—Ç 1
‚Ä¢ –§–∞–∫—Ç 2

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
(–∏—Ç–æ–≥–∏, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ! –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.""",

            "question": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –î–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê:

# ‚ùì –í–æ–ø—Ä–æ—Å: {topic}

## ‚úÖ –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
(–ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

## üìñ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç
(—Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)

## üìù –ü—Ä–∏–º–µ—Ä—ã
1. –ü—Ä–∏–º–µ—Ä
2. –ü—Ä–∏–º–µ—Ä

## üéØ –ò—Ç–æ–≥
(–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)""",

            "retell": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –°–¥–µ–ª–∞–π –ø–µ—Ä–µ—Å–∫–∞–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–∞ —Ç–µ–º—É "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê:

# üìñ –ü–ï–†–ï–°–ö–ê–ó: {topic}

## –û —á—ë–º –º–∞—Ç–µ—Ä–∏–∞–ª
(–∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

## –ü–æ–¥—Ä–æ–±–Ω—ã–π –ø–µ—Ä–µ—Å–∫–∞–∑
(–∏–∑–ª–æ–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏)

## –ì–ª–∞–≤–Ω—ã–µ –º—ã—Å–ª–∏
‚Ä¢ –ú—ã—Å–ª—å 1
‚Ä¢ –ú—ã—Å–ª—å 2
‚Ä¢ –ú—ã—Å–ª—å 3""",

            "essay": f"""{wiki_context}

–ó–ê–î–ê–ù–ò–ï: –ù–∞–ø–∏—à–∏ —ç—Å—Å–µ –Ω–∞ —Ç–µ–º—É "{topic}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –û–±—ä—ë–º: {volume_text}
- –°—Ç–∏–ª—å: {style_text}
- –§–æ—Ä–º–∞—Ç: —ç—Å—Å–µ —Å –ª–∏—á–Ω—ã–º–∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º–∏
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ

–°–¢–†–£–ö–¢–£–†–ê:

# ‚úçÔ∏è –≠–°–°–ï: {topic}

*"[–ü–æ–¥—Ö–æ–¥—è—â–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞]"*

## –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ
(–≤–≤–µ–¥–µ–Ω–∏–µ –≤ —Ç–µ–º—É, –ª–∏—á–Ω–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ)

## –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è

### [–ü–µ—Ä–≤—ã–π –∞—Å–ø–µ–∫—Ç]
(—Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏)

### [–í—Ç–æ—Ä–æ–π –∞—Å–ø–µ–∫—Ç]
(–¥—Ä—É–≥–∞—è —Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è)

### [–¢—Ä–µ—Ç–∏–π –∞—Å–ø–µ–∫—Ç]
(–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã)

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
(–ª–∏—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã, —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –º—ã—Å–ª—å)"""
        }
        
        return prompts.get(mode, prompts["referat"])
    
    def _generate_title_page(self, topic: str, author_info: dict, mode: str) -> str:
        """–¢–∏—Ç—É–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
        
        work_type = {
            "referat": "–†–ï–§–ï–†–ê–¢",
            "doklad": "–î–û–ö–õ–ê–î", 
            "essay": "–≠–°–°–ï"
        }.get(mode, "–†–ï–§–ï–†–ê–¢")
        
        edu_type = author_info.get('edu_type', '–°—Ç—É–¥–µ–Ω—Ç')
        grade = author_info.get('grade', '1')
        name = author_info.get('name', '')
        institution = author_info.get('institution', '')
        group = author_info.get('group', '')
        teacher = author_info.get('teacher', '')
        
        grade_text = f"{grade} –∫–ª–∞—Å—Å–∞" if edu_type == "–£—á–µ–Ω–∏–∫" else f"{grade} –∫—É—Ä—Å–∞"
        year = datetime.now().year
        
        lines = [
            "=" * 60,
            "",
            institution.upper() if institution else "[–£–ß–ï–ë–ù–û–ï –ó–ê–í–ï–î–ï–ù–ò–ï]",
            "",
            "-" * 60,
            "",
            work_type,
            "",
            "–Ω–∞ —Ç–µ–º—É:",
            f'¬´{topic}¬ª',
            "",
            "-" * 60,
            "",
            "–í—ã–ø–æ–ª–Ω–∏–ª(–∞):",
            f"{edu_type} {grade_text}",
        ]
        
        if name:
            lines.append(name)
        if group:
            lines.append(f"–ì—Ä—É–ø–ø–∞: {group}")
        if teacher:
            lines.extend(["", f"–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: {teacher}"])
        
        lines.extend(["", "-" * 60, "", f"{year} –≥–æ–¥", "", "=" * 60])
        
        return "\n".join(lines)
