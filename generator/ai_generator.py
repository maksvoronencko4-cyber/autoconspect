"""
AI Генератор текстов с использованием Google Gemini
"""

import os
import google.generativeai as genai
from datetime import datetime


class AIGenerator:
    """Генератор учебных текстов на основе AI"""
    
    def __init__(self):
        api_key = os.getenv('GEMINI_API_KEY')
        if api_key:
            genai.configure(api_key=api_key)
            self.model = genai.GenerativeModel('gemini-1.5-flash')
            self.is_ready = True
        else:
            self.model = None
            self.is_ready = False
    
    def generate(self, mode: str, topic: str, volume: str, style: str, author_info: dict = None) -> str:
        """Генерация текста"""
        
        if not self.is_ready:
            return "Ошибка: API ключ не настроен"
        
        # Получаем промпт
        prompt = self._build_prompt(mode, topic, volume, style, author_info)
        
        try:
            response = self.model.generate_content(prompt)
            result = response.text
            
            # Добавляем титульную страницу если нужно
            if author_info and author_info.get('include_title') and mode in ['referat', 'doklad', 'essay']:
                title_page = self._generate_title_page(topic, author_info, mode)
                result = title_page + "\n\n" + result
            
            return result
            
        except Exception as e:
            return f"Ошибка генерации: {str(e)}"
    
    def _build_prompt(self, mode: str, topic: str, volume: str, style: str, author_info: dict) -> str:
        """Построение промпта для AI"""
        
        # Настройки объёма
        volume_instructions = {
            "short": "Напиши кратко, 1-2 страницы текста.",
            "medium": "Напиши средний объём, 3-5 страниц текста.",
            "long": "Напиши подробно, 6-10 страниц текста.",
            "very_long": "Напиши очень подробно и развёрнуто, 10-15 страниц текста."
        }
        
        # Настройки стиля
        style_instructions = {
            "scientific": "Используй научный академический стиль с терминологией.",
            "simple": "Используй простой понятный язык для широкой аудитории.",
            "school": "Используй язык, понятный школьнику, с простыми объяснениями.",
            "university": "Используй язык для студента университета с профессиональной терминологией."
        }
        
        volume_text = volume_instructions.get(volume, volume_instructions["medium"])
        style_text = style_instructions.get(style, style_instructions["scientific"])
        
        # Промпты для разных режимов
        prompts = {
            "referat": f"""
Напиши полноценный реферат на тему: "{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА РЕФЕРАТА:
1. ВВЕДЕНИЕ
   - Актуальность темы
   - Цели и задачи работы
   - Предмет и объект исследования

2. ОСНОВНАЯ ЧАСТЬ (несколько глав с подразделами)
   - Раскрой тему полностью
   - Используй факты, даты, имена
   - Приводи примеры
   - Каждый раздел должен быть содержательным

3. ЗАКЛЮЧЕНИЕ
   - Выводы по работе
   - Основные результаты

4. СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ
   - Укажи 5-7 реальных или правдоподобных источников

Пиши как настоящий реферат, который можно сдать учителю!
""",
            
            "conspect": f"""
Напиши подробный конспект на тему: "{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА КОНСПЕКТА:
1. ТЕМА И ОСНОВНЫЕ ПОНЯТИЯ
   - Определения ключевых терминов
   - Основные понятия с объяснениями

2. ОСНОВНОЕ СОДЕРЖАНИЕ
   - Главные факты и даты
   - Ключевые события/процессы/явления
   - Причинно-следственные связи
   - Важные имена и их роль

3. СХЕМЫ И КЛАССИФИКАЦИИ
   - Классификации (если применимо)
   - Этапы развития
   - Виды и типы

4. ВЫВОДЫ И ИТОГИ
   - Главные мысли
   - Что нужно запомнить

Используй:
- Маркированные списки (•)
- Нумерованные списки (1, 2, 3)
- Выделение ключевых слов
- Короткие абзацы

Пиши так, чтобы по этому конспекту можно было подготовиться к уроку!
""",
            
            "doklad": f"""
Напиши полный текст доклада на тему: "{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА ДОКЛАДА:

1. ВСТУПЛЕНИЕ
   - Приветствие аудитории
   - Представление темы
   - Почему эта тема важна и интересна

2. ОСНОВНАЯ ЧАСТЬ
   - Полное раскрытие темы
   - Исторические факты (если применимо)
   - Современное состояние вопроса
   - Интересные факты и примеры
   - Мнения экспертов

3. ЗАКЛЮЧЕНИЕ
   - Подведение итогов
   - Главные выводы
   - Благодарность за внимание

Пиши так, чтобы это можно было прочитать перед классом!
Текст должен быть интересным и увлекательным.
""",
            
            "question": f"""
Дай полный развёрнутый ответ на вопрос: "{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА ОТВЕТА:

1. КРАТКИЙ ОТВЕТ
   - Прямой ответ на вопрос (2-3 предложения)

2. РАЗВЁРНУТЫЙ ОТВЕТ
   - Подробное объяснение
   - Факты и доказательства
   - Примеры из жизни или истории
   - Разные точки зрения (если есть)

3. ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
   - Интересные факты по теме
   - Связь с другими темами

4. ВЫВОД
   - Итоговое заключение

Ответ должен быть полным и подходить для устного ответа на уроке!
""",
            
            "retell": f"""
Сделай подробный пересказ текста:

"{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА ПЕРЕСКАЗА:

1. КРАТКОЕ СОДЕРЖАНИЕ
   - О чём этот текст (2-3 предложения)

2. ПОДРОБНЫЙ ПЕРЕСКАЗ
   - Изложи основное содержание своими словами
   - Сохрани главную мысль
   - Сохрани последовательность событий
   - Упомяни ключевые детали

3. ГЛАВНАЯ МЫСЛЬ
   - Что хотел сказать автор
   - Основная идея текста

4. КЛЮЧЕВЫЕ МОМЕНТЫ
   - Список главных фактов/событий
""",
            
            "essay": f"""
Напиши эссе на тему: "{topic}"

ТРЕБОВАНИЯ:
- {volume_text}
- {style_text}
- Пиши на русском языке

СТРУКТУРА ЭССЕ:

1. ВСТУПЛЕНИЕ
   - Эпиграф (цитата по теме)
   - Введение в тему
   - Почему эта тема важна лично для автора

2. ОСНОВНАЯ ЧАСТЬ
   - Размышления по теме
   - Личное мнение с аргументами
   - Примеры из жизни, литературы, истории
   - Разные точки зрения
   - Анализ проблемы

3. ЗАКЛЮЧЕНИЕ
   - Выводы
   - Личная позиция автора
   - Финальная мысль

Эссе должно быть авторским, с личными размышлениями!
"""
        }
        
        return prompts.get(mode, prompts["referat"])
    
    def _generate_title_page(self, topic: str, author_info: dict, mode: str) -> str:
        """Генерация титульной страницы"""
        
        work_types = {
            "referat": "РЕФЕРАТ",
            "doklad": "ДОКЛАД",
            "essay": "ЭССЕ"
        }
        work_type = work_types.get(mode, "РЕФЕРАТ")
        
        edu_type = author_info.get('edu_type', 'Студент')
        grade = author_info.get('grade', '1')
        name = author_info.get('name', '')
        institution = author_info.get('institution', '')
        group = author_info.get('group', '')
        teacher = author_info.get('teacher', '')
        
        if edu_type == "Ученик":
            grade_text = f"{grade} класса"
        else:
            grade_text = f"{grade} курса"
        
        year = datetime.now().year
        
        lines = [
            "=" * 60,
            "",
            institution.upper() if institution else "[УЧЕБНОЕ ЗАВЕДЕНИЕ]",
            "",
            "-" * 60,
            "",
            work_type,
            "",
            "на тему:",
            f'«{topic}»',
            "",
            "-" * 60,
            "",
            "Выполнил(а):",
            f"{edu_type} {grade_text}",
        ]
        
        if name:
            lines.append(name)
        
        if group:
            lines.append(f"Группа: {group}")
        
        if teacher:
            lines.append("")
            lines.append(f"Преподаватель: {teacher}")
        
        lines.extend([
            "",
            "-" * 60,
            "",
            f"{year} год",
            "",
            "=" * 60,
        ])
        
        return "\n".join(lines)
